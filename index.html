<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Restaurant Assistant</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #fafafa;
    text-align: center;
    padding: 20px;
  }

  h2 {
    margin-bottom: 10px;
  }

  textarea {
    width: 90%;
    max-width: 600px;
    height: 100px;
    font-size: 16px;
    margin-top: 10px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    resize: vertical;
  }

  .button-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin: 10px 0;
  }

  button {
    background-color: #0078d7;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    flex: 1 1 150px;
    max-width: 200px;
    transition: background 0.2s ease;
  }

  button:hover {
    background-color: #005fa3;
  }

  button:disabled {
    background-color: #999;
    cursor: not-allowed;
  }

  @media (max-width: 500px) {
    button {
      flex: 1 1 100%;
      max-width: none;
    }
  }
</style>
</head>
<body>
<h2>üçΩÔ∏è AI Restaurant Assistant</h2>
<p>Speak or type in any language</p>

<div class="button-container">
  <button id="micBtn">üé§ Speak</button>
</div>

<textarea id="userInput" placeholder="Ask or say something..."></textarea>

<div class="button-container">
  <button id="askBtn">Ask</button>
  <button id="translateBtn">Translate</button>
</div>

<textarea id="response" placeholder="Assistant reply..." readonly></textarea>

<script>
const micBtn = document.getElementById("micBtn");
const askBtn = document.getElementById("askBtn");
const translateBtn = document.getElementById("translateBtn");
const userInput = document.getElementById("userInput");
const responseBox = document.getElementById("response");

// üé§ Ses tanƒ±ma (√ßok dilli + otomatik kapanan)
let recognition;
if ("webkitSpeechRecognition" in window) {
  recognition = new webkitSpeechRecognition();

  recognition.continuous = false;
  recognition.interimResults = false;

  // üåç Dili otomatik belirle
  const userLang = navigator.language || "en-US";
  recognition.lang =
    userLang.startsWith("tr") ? "tr-TR" :
    userLang.startsWith("fr") ? "fr-FR" :
    userLang.startsWith("ar") ? "ar-SA" :
    userLang.startsWith("ja") ? "ja-JP" :
    userLang.startsWith("zh-CN") ? "zh-CN" :
    userLang.startsWith("zh-TW") ? "zh-TW" :
    "en-US";

  recognition.onstart = () => {
    micBtn.textContent = "üéôÔ∏è Listening...";
    micBtn.disabled = true;
  };

  recognition.onresult = (event) => {
    userInput.value = event.results[0][0].transcript;
    recognition.stop(); // konu≈üma bitince durdur
  };

  recognition.onerror = (event) => {
    console.error("Speech recognition error:", event.error);
    if (event.error === "no-speech" || event.error === "audio-capture") {
      alert("L√ºtfen mikrofonu kontrol edin ve tekrar deneyin.");
    } else if (event.error === "not-allowed" || event.error === "service-not-allowed") {
      alert("Mikrofona izin verilmedi veya tarayƒ±cƒ± engelledi. L√ºtfen izinleri kontrol edin.");
    } else {
      alert("Voice recognition error: " + event.error);
    }
    micBtn.textContent = "üé§ Speak";
    micBtn.disabled = false;
  };

  recognition.onend = () => {
    micBtn.textContent = "üé§ Speak";
    micBtn.disabled = false;
    console.log("Voice recognition ended.");
  };
} else {
  micBtn.disabled = true;
  micBtn.textContent = "üé§ Not supported";
}

micBtn.addEventListener("click", async () => {
  if (!recognition) return;
  try {
    await navigator.mediaDevices.getUserMedia({ audio: true });
    recognition.start();
  } catch (err) {
    console.error("Microphone access error:", err);
    alert("Mikrofona eri≈üim saƒülanamadƒ±. L√ºtfen izin verdiƒüinizden emin olun.");
  }
});

// üß† GPT Worker Fonksiyonu
async function askGPTWorker(prompt, menuData, mode="menu") {
  let fullPrompt = "";

  if (mode === "menu") {
    fullPrompt = `
You are a multilingual restaurant assistant.
You understand any language and respond in the same language as the customer.
If the customer asks for a category (like drinks, vegan, spicy, etc.), use that filter on the menu.
Menu data:
${JSON.stringify(menuData, null, 2)}
Customer says: "${prompt}"
Reply kindly, and give 1‚Äì2 suitable suggestions from the menu.
`;
  } else if (mode === "translate") {
    fullPrompt = `
You are a translator.
Translate the following text into English (or target language if specified):
"${prompt}"
Only output the translated text.
`;
  }

  const res = await fetch("https://mandarinopenai.furkan285saglam.workers.dev/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: mode === "menu" ? "You are a helpful restaurant assistant." : "You are a translator." },
        { role: "user", content: fullPrompt }
      ]
    })
  });

  const data = await res.json();
  return data.choices?.[0]?.message?.content?.trim() || "No response.";
}

// üßæ Ask butonu
askBtn.addEventListener("click", async () => {
  const text = userInput.value.trim();
  if (!text) return;
  responseBox.value = "Thinking...";

  try {
    const menuRes = await fetch("menu.json");
    const menuData = await menuRes.json();
    const reply = await askGPTWorker(text, menuData, "menu");
    responseBox.value = reply;
  } catch (err) {
    console.error(err);
    responseBox.value = "Error: " + err.message;
  }
});

// üßæ Translate butonu
translateBtn.addEventListener("click", async () => {
  const text = userInput.value.trim();
  if (!text) return;
  responseBox.value = "Translating...";

  try {
    const reply = await askGPTWorker(text, [], "translate");
    responseBox.value = reply;
  } catch (err) {
    console.error(err);
    responseBox.value = "Error: " + err.message;
  }
});
</script>
</body>
</html>
