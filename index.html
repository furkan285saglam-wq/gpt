<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bosphorus Lounge Restaurant Assistant</title>
<style>
body { font-family: Arial, sans-serif; background:#fafafa; padding:20px; text-align:center; }
h2 { margin-bottom:6px; }
p.sub { margin-top:0; color:#555; }
textarea { width:90%; max-width:600px; height:100px; font-size:16px; margin:10px auto; padding:10px; border-radius:8px; border:1px solid #ccc; resize:vertical; display:block; }
.button-container { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin:10px 0; }
button { background:#0078d7; color:#fff; border:none; padding:12px 20px; border-radius:8px; font-size:16px; cursor:pointer; flex:1 1 150px; max-width:200px; transition:background .15s; }
button:hover { background:#005fa3; }
button:disabled { background:#999; cursor:not-allowed; }
@media (max-width:500px) { button { flex:1 1 100%; max-width:none; } textarea { height:120px; } }
.small { font-size:13px; color:#666; margin-top:6px; }
</style>
</head>
<body>
<h2>üçΩÔ∏è Bosphorus Lounge AI Restaurant Assistant</h2>
<p class="sub">Speak or type in any language</p>

<div class="button-container">
  <button id="micBtn">üé§ Speak</button>
</div>

<textarea id="userInput" placeholder="Ask or say something..."></textarea>

<div class="button-container">
  <button id="askBtn">Ask</button>
  <button id="translateBtn">Translate</button>
</div>

<textarea id="response" placeholder="Assistant reply..." readonly></textarea>
<p class="small" id="debug"></p>

<script>
const micBtn = document.getElementById('micBtn');
const askBtn = document.getElementById('askBtn');
const translateBtn = document.getElementById('translateBtn');
const userInput = document.getElementById('userInput');
const responseBox = document.getElementById('response');
const debugEl = document.getElementById('debug');

/* ---------- Record audio with auto stop on silence ---------- */
micBtn.addEventListener('click', async () => {
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    alert('Tarayƒ±cƒ± mikrofon eri≈üimini desteklemiyor.');
    return;
  }

  micBtn.disabled = true;
  micBtn.textContent = 'üéôÔ∏è Listening...';
  debugEl.textContent = 'Listening...';

  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    const audioChunks = [];
    const mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => { if(e.data.size>0) audioChunks.push(e.data); };
    mediaRecorder.start();

    /* ---------- Silence Detection ---------- */
    const audioContext = new AudioContext();
    const source = audioContext.createMediaStreamSource(stream);
    const analyser = audioContext.createAnalyser();
    analyser.fftSize = 512;
    source.connect(analyser);
    const dataArray = new Uint8Array(analyser.frequencyBinCount);

    let silenceStart = null;
    const checkSilence = () => {
      analyser.getByteFrequencyData(dataArray);
      const avg = dataArray.reduce((a,b)=>a+b,0)/dataArray.length;
      if(avg < 5){ 
        if(!silenceStart) silenceStart = Date.now();
        else if(Date.now() - silenceStart > 800){
          mediaRecorder.stop();
          audioContext.close();
          return;
        }
      }else{
        silenceStart = null;
      }
      requestAnimationFrame(checkSilence);
    };
    checkSilence();

    mediaRecorder.onstop = async () => {
      stream.getTracks().forEach(track=>track.stop());
      const audioBlob = new Blob(audioChunks,{ type:'audio/webm' });

      debugEl.textContent = 'Sending audio to server...';
      const formData = new FormData();
      formData.append('file', audioBlob, 'recording.webm');

      try{
        const res = await fetch('https://mandarinopenai.furkan285saglam.workers.dev/',{
          method:'POST',
          body: formData
        });

        const rawText = await res.text();
        let data;
        try{
          data = JSON.parse(rawText);
        }catch(e){
          console.error('JSON parse error:', e);
          alert('Worker JSON d√∂nd√ºrmedi: '+rawText);
          micBtn.disabled = false;
          micBtn.textContent = 'üé§ Speak';
          debugEl.textContent = 'JSON parse error';
          return;
        }

        // üîπ Konu≈üulan dili koruyarak yaz
        if(data && data.text){
          userInput.value = data.text;
          debugEl.textContent = 'Transcription complete';
        }else{
          debugEl.textContent = 'No transcription returned';
          alert('Speech recognition failed.');
        }

      }catch(err){
        console.error(err);
        alert('Error sending audio: '+(err.message||err));
      }

      micBtn.disabled = false;
      micBtn.textContent = 'üé§ Speak';
    };

  }catch(err){
    console.error(err);
    alert('Error accessing microphone: '+(err.message||err));
    micBtn.disabled = false;
    micBtn.textContent = 'üé§ Speak';
  }
});

/* ---------- GPT Worker ---------- */
async function askGPTWorker(prompt, menuData=[], mode='menu'){
  let fullPrompt = '';
  if(mode==='menu'){
    fullPrompt = `
You are a multilingual restaurant assistant.
You understand any language and respond in the same language as the customer.
Menu data: ${JSON.stringify(menuData,null,2)}
Customer says: "${prompt}"
Reply kindly, and give 1‚Äì2 suitable suggestions from the menu.
`;
  }else if(mode==='translate'){
    fullPrompt = `
You are a translator.
Translate the following text into English (or target language if specified):
"${prompt}"
Only output the translated text.
`;
  }

  try{
    const res = await fetch('https://mandarinopenai.furkan285saglam.workers.dev/',{
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({
        model:'gpt-4o-mini',
        messages:[
          {role:'system', content: mode==='menu' ? 'You are a helpful restaurant assistant.' : 'You are a translator.'},
          {role:'user', content: fullPrompt}
        ]
      })
    });
    const data = await res.json();
    return data.choices?.[0]?.message?.content?.trim()||'No response.';
  }catch(e){
    console.error('askGPTWorker error',e);
    return 'Error contacting GPT worker';
  }
}

/* ---------- Ask button ---------- */
askBtn.addEventListener('click', async ()=>{
  const text = userInput.value.trim();
  if(!text) return;
  responseBox.value='Thinking...';
  try{
    const menuRes = await fetch('menu.json');
    const menuData = await menuRes.json();
    const reply = await askGPTWorker(text, menuData,'menu');
    responseBox.value = reply;
  }catch(err){
    console.error(err);
    responseBox.value = 'Error: '+(err.message||err);
  }
});

/* ---------- Translate button ---------- */
translateBtn.addEventListener('click', async ()=>{
  const text = userInput.value.trim();
  if(!text) return;
  responseBox.value='Translating...';
  try{
    const reply = await askGPTWorker(text, [], 'translate');
    responseBox.value = reply;
  }catch(err){
    console.error(err);
    responseBox.value='Error: '+(err.message||err);
  }
});
</script>
</body>
</html>

